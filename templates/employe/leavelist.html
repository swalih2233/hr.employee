{% extends "base/base.html" %}
{% block container %}
{% load static %}

  <!-- Header -->
  <header class="bg-white shadow-sm px-4 md:px-6 py-4 flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <!-- Logo -->
         <!-- Logo -->
   <a href="{% url 'employe:details' %}" class="flex items-center">
        <img src="/static/images/Black Transparent Mavendeor .png"
             alt="Logo"
             class="h-11 md:h-[70px] w-auto object-contain">
    </a>
      <!-- Search (hidden on mobile) -->
      
    </div>
    <div class="flex items-center space-x-3 md:space-x-6">
      
      <img src="{% if profile.image %}{{ profile.image.url }}{% else %}{% static 'images/1.png' %}{% endif %}" class="w-8 h-8 md:w-9 md:h-9 rounded-full object-cover cursor-pointer">
    </div>
  </header>

<section class="pt-6 md:pt-[10vh] pb-6">



  <div class="container mx-auto px-4">
        <!-- Back Link -->
  <div class="mb-6">
    <a href="{% url 'employe:details' %}" class="text-blue-600 hover:underline text-sm font-medium inline-flex items-center">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Home
    </a>
  </div>

    <!-- Django Messages Framework -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="p-4 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}" role="alert">
            <p class="text-sm">{{ message }}</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Page Title -->
    <div class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">My Leave Requests</h1>
      <p class="text-sm text-gray-500 mt-1">View and track all your leave applications</p>
    </div>

    <!-- FILTERS -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex flex-wrap gap-3">
        <input type="text" 
               id="searchInput"
               placeholder="Search..." 
               class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full sm:w-auto sm:flex-1 focus:ring-2 focus:ring-indigo-500">
        <select id="typeFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full sm:w-auto focus:ring-2 focus:ring-indigo-500">
          <option value="">All Type</option>
          <option value="Annual Leave">Annual Leave</option>
          <option value="Medical Leave">Medical Leave</option>
        </select>
        <select id="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full sm:w-auto focus:ring-2 focus:ring-indigo-500">
          <option value="">All Status</option>
          <option value="APPROVED">Approved</option>
          <option value="PENDING">Pending</option>
          <option value="REJECTED">Rejected</option>
          <option value="CANCELLED">Cancelled</option>
        </select>
      </div>
    </div>

    <!-- DESKTOP TABLE -->
    <div class="overflow-x-auto hidden md:block bg-white rounded-lg shadow">
      <table id="leaveTable" class="min-w-full">
        <thead class="bg-gray-50 text-gray-600 text-xs uppercase">
          <tr>
            <th class="py-3 px-4 text-left font-medium">Subject</th>
            <th class="py-3 px-4 text-left font-medium">From</th>
            <th class="py-3 px-4 text-left font-medium">To</th>
            <th class="py-3 px-4 text-left font-medium">Total</th>
            <th class="py-3 px-4 text-left font-medium">Type</th>
            <th class="py-3 px-4 text-left font-medium">Attachment</th>
            <th class="py-3 px-4 text-left font-medium">Status</th>
            <th class="py-3 px-4 text-left font-medium">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for instance in instances %}
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="py-3 px-4 text-sm">{{ instance.subject }}</td>
            <td class="py-3 px-4 text-sm">{{ instance.start_date|date:"d M Y" }}</td>
            <td class="py-3 px-4 text-sm">{{ instance.end_date|date:"d M Y" }}</td>
            <td class="py-3 px-4 text-sm">{{ instance.leave_duration }} Days</td>
            <td class="py-3 px-4 text-sm type-col">{{ instance.get_leave_type_display }}</td>
            <td class="py-3 px-4 text-sm">
              {% if instance.attachment %}
                <a href="{{ instance.attachment.url }}" class="text-blue-600 hover:text-blue-800 underline">
                  <i class="fas fa-file-download mr-1"></i>Download
                </a>
              {% else %}
                <span class="text-gray-400">â€“</span>
              {% endif %}
            </td>
            <td class="py-3 px-4 status-col">
              {% if instance.is_approved %}
                <span class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-1 rounded-full">APPROVED</span>
              {% elif instance.is_rejected %}
                <span class="bg-red-100 text-red-700 text-xs font-semibold px-2 py-1 rounded-full">REJECTED</span>
              {% elif instance.is_cancelled %}
                <span class="bg-gray-100 text-gray-700 text-xs font-semibold px-2 py-1 rounded-full">CANCELLED</span>
              {% else %}
                <span class="bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-1 rounded-full">PENDING</span>
              {% endif %}
            </td>
            <td class="py-3 px-4 text-sm">
              {% if not instance.is_approved and not instance.is_rejected and not instance.is_cancelled %}
                <a href="{% url 'employe:cancel_leave' instance.id %}" 
                   class="text-red-600 hover:text-red-800 font-medium flex items-center"
                   onclick="return confirm('Are you sure you want to cancel this leave request?')">
                  <i class="fas fa-times-circle mr-1"></i> Cancel
                </a>
              {% else %}
                <span class="text-gray-400">No Actions</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="py-8 text-center text-gray-500">
              <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
              <p>No leave requests found.</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- MOBILE CARDS -->
    <div class="block md:hidden space-y-4" id="mobileLeaveCards">
      {% for instance in instances %}
      <div class="bg-white border rounded-lg shadow p-4 mobile-card">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-3">
            {% if instance.employe.image %}
              <img src="{{ instance.employe.image.url }}" alt="" class="w-12 h-12 rounded-full object-cover">
            {% else %}
              <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fas fa-user text-gray-400"></i>
              </div>
            {% endif %}
            <div>
              <p class="font-semibold text-gray-900">{{ instance.employe.user.first_name }} {{ instance.employe.user.last_name }}</p>
              <p class="text-xs text-gray-500 type-col">{{ instance.get_leave_type_display }}</p>
            </div>
          </div>
          <div class="status-col">
            {% if instance.is_approved %}
              <span class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-1 rounded-full">APPROVED</span>
            {% elif instance.is_rejected %}
              <span class="bg-red-100 text-red-700 text-xs font-semibold px-2 py-1 rounded-full">REJECTED</span>
            {% elif instance.is_cancelled %}
              <span class="bg-gray-100 text-gray-700 text-xs font-semibold px-2 py-1 rounded-full">CANCELLED</span>
            {% else %}
              <span class="bg-yellow-100 text-yellow-700 text-xs font-semibold px-2 py-1 rounded-full">PENDING</span>
            {% endif %}
          </div>
        </div>
        
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600 font-medium">Subject:</span>
            <span class="text-gray-900 text-right">{{ instance.subject }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 font-medium">From:</span>
            <span class="text-gray-900">{{ instance.start_date|date:"d M Y" }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 font-medium">To:</span>
            <span class="text-gray-900">{{ instance.end_date|date:"d M Y" }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600 font-medium">Duration:</span>
            <span class="text-gray-900 font-semibold">{{ instance.leave_duration }} Days</span>
          </div>
          {% if instance.attachment %}
          <div class="pt-2 border-t">
            <a href="{{ instance.attachment.url }}" class="text-blue-600 hover:text-blue-800 underline text-sm flex items-center">
              <i class="fas fa-file-download mr-2"></i>Download Attachment
            </a>
          </div>
          {% endif %}
          
          {% if not instance.is_approved and not instance.is_rejected and not instance.is_cancelled %}
          <div class="pt-2 border-t mt-2">
            <a href="{% url 'employe:cancel_leave' instance.id %}" 
               class="text-red-600 hover:text-red-800 font-medium flex items-center justify-center w-full py-2 bg-red-50 rounded-lg"
               onclick="return confirm('Are you sure you want to cancel this leave request?')">
              <i class="fas fa-times-circle mr-2"></i> Cancel Leave
            </a>
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="text-center py-12 text-gray-500 bg-white rounded-lg shadow">
        <i class="fas fa-inbox text-5xl mb-3 text-gray-300"></i>
        <p class="text-lg">No leave requests found.</p>
      </div>
      {% endfor %}
    </div>

  </div>
</section>

<!-- JS FILTERS -->
<script>
// Search filter
document.getElementById("searchInput").addEventListener("keyup", function() {
  let filter = this.value.toLowerCase();
  
  // Filter desktop table
  document.querySelectorAll("#leaveTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
  
  // Filter mobile cards
  document.querySelectorAll(".mobile-card").forEach(card => {
    card.style.display = card.innerText.toLowerCase().includes(filter) ? "" : "none";
  });
});

// Type filter
document.getElementById("typeFilter").addEventListener("change", function() {
  let filter = this.value;
  
  // Filter desktop table
  document.querySelectorAll("#leaveTable tbody tr").forEach(row => {
    let type = row.querySelector(".type-col")?.innerText.trim();
    row.style.display = filter === "" || type === filter ? "" : "none";
  });
  
  // Filter mobile cards
  document.querySelectorAll(".mobile-card").forEach(card => {
    let type = card.querySelector(".type-col")?.innerText.trim();
    card.style.display = filter === "" || type === filter ? "" : "none";
  });
});

// Status filter
document.getElementById("statusFilter").addEventListener("change", function() {
  let filter = this.value;
  
  // Filter desktop table
  document.querySelectorAll("#leaveTable tbody tr").forEach(row => {
    let status = row.querySelector(".status-col span")?.innerText.trim();
    row.style.display = filter === "" || status === filter ? "" : "none";
  });
  
  // Filter mobile cards
  document.querySelectorAll(".mobile-card").forEach(card => {
    let status = card.querySelector(".status-col span")?.innerText.trim();
    card.style.display = filter === "" || status === filter ? "" : "none";
  });
});
</script>

{% endblock %}